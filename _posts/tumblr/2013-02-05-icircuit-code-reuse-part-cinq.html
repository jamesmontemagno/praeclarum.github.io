---
layout: post
title:  "iCircuit Code Reuse, Part Cinq"
date:   2013-02-05 21:53:09 GMT
redirect_from:
  - /post/42378027611
  - /post/42378027611/icircuit-code-reuse-part-cinq
---


<p>I have toiled away with the new Windows 8 OS, the new Visual Studio 2012, and the new Office 13/365 to present you, dear reader, with this fine set of charts:</p>


<p><img alt="image" src="https://78.media.tumblr.com/566335601c4ad71a29602f119afe2510/tumblr_inline_mhrlp1np9s1qbzjil.png"/></p>


<p>(This post is the 5th in a series where I describe the code reuse of <a href="http://icircuitapp.com">iCircuit</a> while porting it from platform to platform. Check out the <a href="http://praeclarum.org/post/15789866032/icircuit-code-reuse-part-trois">previous</a> <a href="http://praeclarum.org/post/31799384896/icircuit-code-reuse-the-fourth-edition">posts</a>.)</p>


<p>Yesterday I completed the Metro, I mean Windows Store Modern App, version of iCircuit and achieved 85% code reuse from my other platforms! You should check it out, it&rsquo;s amazing to see Windows 8 actually do something useful! ;-)</p>


<p><a href="http://apps.microsoft.com/windows/en-US/app/icircuit/4041b312-408b-4bea-9c16-c49529230173" title="iCircuit on the Windows 8 Store">iCircuit for Windows 8</a></p>


<p>To build this version, I used the work from the Windows Phone 7 port to get the basic app working in a XAML/C# solution. From there I &ldquo;just&rdquo; had to build up a modern desktop/tablet UI for the app. The initial port took about 1 day. Then I spent about 2 months refining the UI to feel good.</p>


<p>Thanks to the amazing .NET/Mono platform I was able to <strong>reuse 39,000</strong> lines of code and had to <strong>write 6,700 lines of platform dependent code</strong>. These figures represent a <strong>code reuse of 85%</strong>. This is on-par with all my other ports, and so I deem it a success.</p>


<p>That said, I&rsquo;m a little disappointed that I had to write 6,700 lines. I was hoping for code reuse more inline with the OS X port of the app where I only had to write 4,000 loc. I blame WinRT&rsquo;s immaturity. You would be shocked to see some of the crazy bits of code I had to put in because the Win8 platform, while very rich, is also very generic and doesn&rsquo;t help you at all to build standard apps (document based, tools, etc.) That is to say, Cocoa is a very mature platform designed to make apps feature-rich and consistent while also making the developer&rsquo;s life easy. WinRT on the other hand gives you rectangles and a blog post that says &ldquo;good luck&rdquo;.</p>


<p>Post Mortem</p>

<ul><li><strong>Microsoft did a great job of porting XAML graphics</strong> over to this new brave DirectX world. All my Silverlight code worked out of the gate and had decent performance.</li>
<li>The <strong>XAML implementation is slow</strong> as a snail slithering up a mountain during a rainstorm <strong>when it comes to changing the scale of render transforms</strong>. I can pan around with high FPS but the moment you zoom in or out, the app feels like we&rsquo;re back in the 80s. Now, this is probably not Microsoft&rsquo;s fault since the perf profiler says that I spend all that stalled time in video card drivers (Intel 3000 on my dev machine), but Microsoft should lay some tough love on these hardware peeps.</li>
<li>WinRT introduces<strong> yet another way to track multi-touch</strong>. Now we have to wire up 5 Pointer events instead of a single Touch event from Silverlight. Check out <a href="https://github.com/praeclarum/CrossGraphics/blob/master/src/XamlCanvas.cs#L345">my implementation in CrossGraphics</a> to see the horror unfold. CocoaTouch nailed multi-touch on their first go. This is Microsoft&rsquo;s 3rd attempt. Let&rsquo;s hope they&rsquo;re happy this time.</li>
<li>Just when I thought I had completed the port, I realized that the app isn&rsquo;t functional on non-touch devices - there was a whole list of actions you just couldn&rsquo;t do. So I had to write keyboard and mouse code to make that all happen. Coming from iOS, this felt crazy indeed. Why am I putting keyboard shortcuts into a tablet app? Because <strong>WinRT apps have to be just at home on the desktop as they need to be on tablets</strong>.</li>
<li>The <strong>WinRT XAML implementation isn&rsquo;t able to render the visual tree to bitmaps</strong> (WriteableBitmap does not have the Render method). Let me just add my voice to the 1,000,000s of other devs as we cry &ldquo;Why Microsoft, why???&rdquo; To export PNGs, I had to resort to deep dark black magic of DirectX and Direct2D. Simple question to all the devs on the XAML team: if I can write code to render a visual tree using DirectX that gets dumped into a WIC bitmap, why the hell can&rsquo;t you?</li>
<li><strong>Testing the Share Charm is a real pita</strong>. One little mistake and you will have to reboot Windows (yes, I said reboot Windows) to make sharing work again.</li>
<li>The <strong>Visual Studio performance analysis tools are wonderful</strong>. They give nicely detailed reports in a UI that makes&hellip; well, some sense. It&rsquo;s still lightyears behind Instruments, but it&rsquo;s functional and enabled me to fix some hot spots in the code.</li>
<li>The<strong> file system security model is ludicrous and stupid</strong> and dumb and confusing and stupid and annoying and a pain to use. I had to disable one of my favorite features of iCircuit (subcircuits) because I couldn&rsquo;t find a way to open a StorageFile using just a path. &ldquo;Access Denied&rdquo; all over the place.</li>
<li>The<strong> media system is a piece of crap compared to what we had in Silverlight</strong> and WP7. I, again, had to disable major chunks of the app (microphone, speakers, and buzzer elements) because WInRT doesn&rsquo;t expose the media system to C#. There are &ldquo;capture&rdquo; devices but they incur a 500ms delay because you can&rsquo;t control buffer sizes. And playback, well, let&rsquo;s just say it has many problems too. I greatly miss Microsoft.Xna.Framework.Audio. (Oh, and while we&rsquo;re at it, fuck you MS for cancelling XNA, your only good API. I feel like I can swear now that we&rsquo;re way down in the list.)</li>
<li>The <strong>graphics system of WinRT is very fragile</strong>. I want to do real-time 2D vector drawing. Direct2D is perfect for this. But WinRT puts all sorts of limitations on onscreen rendering, most notably: you can only have 1 DirectX swap chain (view) per window. That means I can&rsquo;t use Direct2D for rendering the scope which means the scope is slower than it needs to be. Dear Microsoft, go spend a few minutes and see how beautifully CocoaTouch and OpenGL work together on iOS. You might get inspired.</li>
<li>The <strong>App Store review process was crazy fast</strong>. It took 5.5 hours for the app to be placed on the store. While I&rsquo;m ecstatic that the review process was so fast, it does leave me wondering. I spent days struggle over the <a href="http://msdn.microsoft.com/en-us/library/windows/apps/hh465424">UX guidelines</a> debating the right way to exposes this feature or that. In the end, it looks like it doesn&rsquo;t even matter. I wonder if they even looked at the app? It&rsquo;s big and complex. It contains a hand-written C compiler for God&rsquo;s sake. It has 5 UI views that are individually larger than most apps on the store. Ah well, it will be up to the users to tell me if the effort was worth it.</li>
<li>This <strong>WinRT version lacks a natively optimized solver</strong>. iCircuit for iOS uses <a href="http://developer.apple.com/library/ios/#documentation/Performance/Conceptual/vecLib/Reference/reference.html#//apple_ref/doc/uid/TP40002498">Apple&rsquo;s Accelerate framework</a> to do the heavy lifting in its solver to get wonderful performance that only gets better as the CPUs get wider and Apple&rsquo;s engineers optimize the library. Windows has none of this. I ran into many problems trying to get this C# app to use a WinRT C++ component but eventually gave up. It&rsquo;s too bad Microsoft doesn&rsquo;t care enough about high-performance computing to integrate useful numerical libraries.</li>
<li>I need a better way to write cross-platform documentation.</li>
</ul>
<p>Thanks for tuning in one more time! I hope you found this at least a tiny bit educational!</p>


<p>So which platform is next? I&rsquo;m thinking of porting it to Windows 7, but will wait to see how sales do first. :-) In the mean time, <a href="http://xamarin.com/monotouch">MonoTouch</a> and I need to spend some quality time together&hellip;</p>

<ul><li><a href="http://apps.microsoft.com/windows/en-US/app/icircuit/4041b312-408b-4bea-9c16-c49529230173" title="iCircuit on the Windows 8 Store">iCircuit for Windows 8</a></li>
<li><a href="http://icircuitapp.com">iCircuit on iOS/OS X/Android/WP7</a></li>
</ul>
